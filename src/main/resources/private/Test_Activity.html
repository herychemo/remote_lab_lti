<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>${{ activity_name }}</title>

	<meta name="viewport"
		  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

	<link rel="stylesheet" href="./css/bootstrap.min.css">
	<style>
		.state-printer{
			padding: 6px;
			text-align: center;
		}
		.state-printer div{
			width: 100%;
			min-height: 30px;
		}
		.state-on div{
			background-color: #62ff3d;
		}
		.state-off div{
			background-color: #c9302c;
		}
		.btn{
			cursor: pointer;
		}
		#user-group .state-printer div{
			cursor: pointer;
		}
	</style>
</head>
<body>

	<!-- Navbar -->
	<nav class="navbar navbar-toggleable-md navbar-light bg-faded">
		<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<!-- Image and text -->
		<nav class="navbar navbar-light bg-faded">
			<a class="navbar-brand" href="#">
				<img src="/logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
				${{ activity_name }}
			</a>
		</nav>

		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item active">
					<a class="nav-link" id="go_back_link" href="${{ go_back_url }}">Return to LMS</a>
				</li>
			</ul>
		</div>
	</nav>

	<div class="container main">
		<h1>${{ activity_name }}, Welcome ${{ student_full_name }}</h1>


		<!-- Simple Video Receptor -->
		<div class="card">
			<div class="card-img-top text-center">
				<img class="" src="./img/loading.gif" alt="Card image cap">
			</div>

			<div class="card-block">
				<p class="card-text"><b>FPS: </b> <i id="fps_printer">0</i></p>
			</div>
		</div>


		<div class="row">

			<div class="col-md-6 card">
				<!-- Activity Instructions -->
				<h3>Instructions</h3>
				<p class="text-justify " id="instructions-printer">
					The Activity is pretty easy!
					<br>1.- Check the Target Led States In The "Target States" Section.
					<br>2.- Configure The Same Led States Order Using The "User States" Section.
					<br>3.- Verify The Physical Circuit Using The Video Stream.
					<br>4.- Click Finish And You'll Get Your Grade.
				</p>
			</div>

			<div class="col-md-6">
				<div class="col-md-12 card">
					<h3>Target States</h3>
					<div class="row" id="target-group">
						<div class="point col state-printer state-on"><div class="rounded"></div><span>On</span></div>
						<div class="point col state-printer state-off"><div class="rounded"></div><span>Off</span></div>
						<div class="point col state-printer state-off"><div class="rounded"></div><span>Off</span></div>
						<div class="point col state-printer state-on"><div class="rounded"></div><span>On</span></div>
					</div>
				</div>

				<div class="col-md-12 card">
					<h3>User States</h3>
					<div class="row" id="user-group">
						<div class="point col state-printer state-on"><div class="rounded" data-led-target="0"></div><span>Led 1</span></div>
						<div class="point col state-printer state-off"><div class="rounded" data-led-target="1"></div><span>Led 2</span></div>
						<div class="point col state-printer state-off"><div class="rounded" data-led-target="2"></div><span>Led 3</span></div>
						<div class="point col state-printer state-on"><div class="rounded" data-led-target="3"></div><span>Led 4</span></div>
					</div>
				</div>
			</div>
		</div>
		<hr>
		<button id="finish-btn" class="btn btn-outline-primary float-right">Finish</button>


	</div>

	<script src="./js/jquery-3.1.1.min.js"></script>
	<script src="./js/tether.min.js"></script>
	<script src="./js/bootstrap.min.js"></script>
	<script>
		// If you want to save a value from templates use this space, eg.
		var go_back_url = "${{ go_back_url }}";

		var $user_group;
		var $target_group;
		var main = function(){
			console.log("jQuery is Working!");

			$user_group = $("#user-group").find(".state-printer div");
			$target_group = $("#target-group").find(".state-printer div");

			//Random combination...
			var initial_states = "";
			for(var i=0; i < 4 ;i++)
				if( Math.random() > 0.5 )	initial_states += "1";
				else						initial_states += "0";
			from_string_to_gui(initial_states, $target_group);

			$user_group.click(function(){
				var url = "./data/toggle/" + $(this).data('led-target');
				$.post(url, function () {
					update_led_states();
				});
			});

			update_led_states();

			$("#finish-btn").click( finish_activity );
		};
		$(main);

		function update_led_states() {
			$.getJSON('./data/led-query', function(data){
				console.log(data);
				from_string_to_gui( data.res, $user_group );
			});
		}
		function from_string_to_gui(states, $group) {
			for (var i = 0 ; i < states.length ; i++){
				var $item = $($group[i]).parent();
				console.log( $item );
				$item.removeClass('state-on');
				$item.removeClass('state-off');
				if( states.charAt(i) === '1' )
					$item.addClass('state-on');
				else
					$item.addClass('state-off');
			}
		}

		function finish_activity() {
			var total = 4;
			var good = 0;
			for(var i=0;i<4;i++){
				var $user_item = $($user_group[i]).parent();
				var $target_item = $($target_group[i]).parent();
				if(
					( $target_item.hasClass('state-on') && $user_item.hasClass('state-on') )
					||
					( $target_item.hasClass('state-off') && $user_item.hasClass('state-off') )
				)	good++;
			}
			var grade = good / total;
			send_grades( grade );
		}
		
		function send_grades( grades ) {
			$.post("./send_grades", {
				lis_outcome_service_url : "${{ lis_outcome_service_url }}",
				key : "${{ key }}",
				secret : "${{ secret }}",
				lis_result_sourcedid : '${{ lis_result_sourcedid }}',
				grade : grades
			}, function (data) {
				data = JSON.parse(data);
				if ( data.res === 'Ok' ){
					$.get("./data/reset");
					alert("See You");
					window.location.replace(go_back_url);
				}else
					alert( data.res );
			});
		}

	</script>
</body>
</html>